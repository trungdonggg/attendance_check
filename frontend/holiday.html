<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holiday</title>
</head>
<body>
  <button type="button">
    <a href="/frontend/main.html">Home</a>
  </button>

  <h1>Holiday Data</h1>

  <!-- Search form -->
  <form>
    Search: <input type="text" id="searchid" placeholder="Job ID..">
    <button type="button" onclick="searchHoliday()">Find</button>
  </form>

<!-- Holiday table -->
<table id="holiday-table" style="display: none;">
    <thead>
      <tr>
        <th>Job ID</th>
        <th>Holiday</th>
        <th>Option</th>
      </tr>
    </thead>
    <tbody id="holiday-list"></tbody>
    <button id="show-form-to-add-holiday">Add</button>
  </table>

 <!-- Form to add holiday -->
 <form id="form-to-add" style="display: none;">
    <label for="jid">Job ID:</label>
    <input type="text" id="jid" name="id" required>
    <label for="holiday_date">Holiday Date:</label>
    <input type="date" id="holiday_date" name="holiday" required>
    <button type="submit">Submit</button>
  </form>

  <div id="success-message" style="display: none;">Data posted successfully!</div>
  <div id="delete-success-message" style="display: none;">Deleted successfully!</div>

  <script>

    function searchHoliday() {
      const search = document.getElementById('searchid').value;
      const holidaytable = document.getElementById('holiday-table');

        if (search ==='*'){
          fetch('http://127.0.0.1:5000/holiday?jid=*')
          .then(response => response.json())
          .then(data => {
            holidaytable.style.display = 'block';
            const holidayList = document.getElementById('holiday-list');
            holidayList.innerHTML = ''; // Clear all data table before adding new data
            data.forEach(holiday => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="text-align:center;">${holiday.jid}</td>
                <td style="text-align:center;">${holiday.holiday_date}</td>
                <td><button onclick="deleteHoliday('${holiday.jid}', '${holiday.holiday_date}')">Delete</button></td>
              `;
              holidayList.appendChild(tr);
            });
          })
          .catch(error => console.error(error));
      } else {
        // Fetch holiday by ID from the API
        fetch(`http://127.0.0.1:5000/holiday?jid=${search}`)
          .then(response => response.json())
          .then(holiday => {
            holidaytable.style.display = 'block';
            const holidayList = document.getElementById('holiday-list');
            holidayList.innerHTML = ''; // Clear all data table before adding new data

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:center;">${holiday.jid}</td>
                <td style="text-align:center;">${holiday.holiday_date}</td>
                <td><button onclick="deleteHoliday('${holiday.jid}', '${holiday.holiday_date}')">Delete</button></td>
              `;
            holidayList.appendChild(tr);
          })
          .catch(error => {
            holidaytable.style.display = 'none';
            console.log('Holiday not found:', error);
          });
      }
    }

    function showAddForm() {
      const addForm = document.getElementById('form-to-add');
      addForm.style.display = 'block';
    }

    function deleteHoliday(jid, holidayDate) {
        const formattedDate = new Date(holidayDate).toISOString().split('T')[0];

        const postData = { jid: jid, holiday_date: formattedDate };

        const options = {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        };

        fetch('http://127.0.0.1:5000/holiday', options)
          .then(response => {
            if (response.ok) {
              const successMessage = document.getElementById('delete-success-message');
              successMessage.style.display = 'block';
              const holidaytable = document.getElementById('holiday-table');
              holidaytable.style.display='none';
              setTimeout(() => {
                holidaytable.style.display = 'block';
                successMessage.style.display = 'none';
                searchHoliday(); // Refresh the holiday data after successful deletion
              }, 1000);
            } else {
              throw new Error('Failed to delete data from API.');
            }
          })
          .catch(error => console.error(error));
      }

    function handleAddFormSubmit(event) {
      event.preventDefault();

      const form = document.getElementById('form-to-add');
      const jid = document.getElementById('jid').value;
      const holiday_date = document.getElementById('holiday_date').value;

      const holidayData = {
        jid: jid,
        holiday_date: holiday_date,
      };

      fetch('http://127.0.0.1:5000/holiday?jid=*', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(holidayData)
      })
        .then(response => response.json())
        .then(data => {
          const postFormContainer = document.getElementById('form-to-add');
          const holidaytable = document.getElementById('holiday-table');
          const postSuccessMessage = document.getElementById('success-message');
          postSuccessMessage.style.display = 'block';
          holidaytable.style.display = 'none';
          postFormContainer.style.display = 'none';
          form.reset();
          console.log('Data Posted successfully:', data);
          setTimeout(()=>{
            // postFormContainer.style.display = 'none';
            postSuccessMessage.style.display = 'none';
            // // Refresh the holiday list
            searchHoliday();
          },1000)
        })
        .catch(error => console.error('Error posting data:', error));
    }

    // Attach event listeners
    document.getElementById('show-form-to-add-holiday').addEventListener('click', showAddForm);
    document.getElementById('form-to-add').addEventListener('submit', handleAddFormSubmit);
  </script>
</body>
</html>
