<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holiday</title>
</head>
<body>
    <button type="button">
      <a href="/frontend/main.html">Home</a>
    </button>

    <h1>Holiday Data</h1>
    <!-- Search form -->
    <form>
      Search: <input type="text" id="searchid" placeholder="Job ID..">
      <button type="button" onclick="searchHoliday()">Find</button>
    </form>

    <!-- Holiday table -->
    <table id="holiday-table">
      <thead>
        <tr>
          <th>Job ID</th>
          <th>Holiday</th>
          <th>Option</th>
        </tr>
      </thead>
      <tbody id="holiday-list"></tbody>
      <button id="show-form-to-add-holiday">Add</button>
    </table>

    <!-- Form to add holiday -->
    <form id="form-to-add" style="display: none;">
      <label for="jid">Job ID:</label>
      <input type="text" id="jid" name="id" required>
      <label for="holiday_date">Holiday Date:</label>
      <input type="date" id="holiday_date" name="holiday" required>
      <button type="submit">Submit</button>
      <div id="success-message" style="display:none">Data posted successfully!<br>Please reload or find again.</div>
    </form>

    <script>
      // Function to fetch and display holiday data
      function searchHoliday() {
        const search = document.getElementById('searchid').value;
        if (search ==='*'){
          fetch('http://127.0.0.1:5000/holiday?jid=*')
          .then(response => response.json())
          .then(data => {
            const holidayList = document.getElementById('holiday-list');
            holidayList.innerHTML = ''; // Clear all data table before adding new data
            data.forEach(holiday => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="text-align:center;">${holiday.jid}</td>
                <td style="text-align:center;">${holiday.holiday_date}</td>
                <td><button onclick="deleteHoliday('${holiday.jid}', '${holiday.holiday_date}')">Delete</button></td>
              `;
              holidayList.appendChild(tr);
            });
          })
          .catch(error => console.error(error));
      } else{
        fetch(`http://127.0.0.1:5000/holiday?jid=${search}`)
          .then(response => response.json())
          .then(data => {
            const holidayList = document.getElementById('holiday-list');
            holidayList.innerHTML = ''; // Clear all data table before adding new data
            data.forEach(holiday => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="text-align:center;">${holiday.jid}</td>
                <td style="text-align:center;">${holiday.holiday_date}</td>
                <td><button onclick="deleteHoliday('${holiday.jid}', '${holiday.holiday_date}')">Delete</button></td>
              `;
              holidayList.appendChild(tr);
            });
          })
          .catch(error => console.error(error));
      }
        }
        

      // Function to add a holiday
      const showFormButton = document.getElementById('show-form-to-add-holiday');
      const form = document.getElementById('form-to-add');
      const successMessage = document.getElementById('success-message');
      showFormButton.addEventListener('click', event => {
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
      });

      form.addEventListener('submit', event => {
        event.preventDefault();

        const postData = {
          jid: form.elements.jid.value,
          holiday_date: form.elements.holiday_date.value,
        };

        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        };

        fetch('http://127.0.0.1:5000/holiday', options)
          .then(response => {
            if (response.ok) {
              successMessage.style.display = 'block';
              form.reset();
              setTimeout(() => {
                successMessage.style.display = 'none';
                form.style.display = 'none';
                fetchHolidayData(); // Refresh the holiday data after successful addition
              }, 2500);
            } else {
              throw new Error('Failed to post data to API.');
            }
          })
          .catch(error => console.error(error));
      });


      // Function to delete a holiday
        function deleteHoliday(jid, holidayDate) {
        const formattedDate = new Date(holidayDate).toISOString().split('T')[0];

        const postData = { jid: jid, holiday_date: formattedDate };

        const options = {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        };

        fetch('http://127.0.0.1:5000/holiday', options)
          .then(response => {
            if (response.ok) {
              const successMessage = document.getElementById('success-message');
              successMessage.style.display = 'block';
              setTimeout(() => {
                successMessage.style.display = 'none';
                fetchHolidayData(); // Refresh the holiday data after successful deletion
              }, 2500);
            } else {
              throw new Error('Failed to delete data from API.');
            }
          })
          .catch(error => console.error(error));
      }
    </script>
</body>
</html>
