<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee</title>
</head>
<body>
    <button type="button">
      <a href="/frontend/main.html">Home</a>
    </button>

    <h1>Employee Data</h1>
          <!-- this is the search form -->
    <form>
      Search: <input type="text" id="searchid" placeholder="Employee ID..">
    <!-- this is button to Find -->
      <button type="button" onclick="searchEmployee()">Find</button>
    </form>

          <!-- This is the employee table -->
    <table id="employee-table">
      <thead>
        <tr>
          <th>Employee ID</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Option</th>
        </tr>
      </thead>
      <tbody id="employee-list"></tbody>
      <!-- this is the button to SHOW FORM for add Employee -->
      <button id="show-form-to-add-employee">Add</button>
    </table>

          <!-- This is the form -->
    <form id="from-to-add">
      <!-- form -->
      <label for="eid">Eid</label>
      <input type="text" id="eid" name="id" required>
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" required>
      <label for="phone">Phone:</label>
      <input type="text" id="phone" name="phone" required>
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>
      <!-- button to submit for add -->
      <button type="submit">Submit</button>
          <!-- Success message element -->
      <div id="success-message" style="display:none">Data posted successfully!<br>Please Reload or Find again</div>
    </form>

    <div id="edit-form-container" style="display: none;">
      <form id="form_to_put">

      <label for="nameput">Name:</label>
      <input type="text" id="nameput" name="name" required>
      <label for="phoneput">Phone:</label>
      <input type="text" id="phoneput" name="phone" required>
      <label for="emailput">Email:</label>
      <input type="email" id="emailput" name="email" required>
      <!-- button to submit for add -->
      <button type="submit">Submit</button>
      <!-- Success message element -->
      <div id="put-success-message" style="display:none">Data updated successfully</div>
      </form>
    </div>

    <!-- Delete success message -->
    <div id="delete-success-message" style="display:none">Data delete successfully</div>
  <script>
          // SEARCH and SHOW Data


        function searchEmployee(){
        const search = document.getElementById('searchid').value;
        if (search === '*') {
        // pull the data from the API
          fetch('http://127.0.0.1:5000/employee?eid=*')
            .then(response => response.json())
            .then(data => {
              const employeeList = document.getElementById('employee-list');
              employeeList.innerHTML = ''; // Clear all data table before adding new data
              data.forEach(employee => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td style="text-align:center;">${employee.eid}</td>
                  <td style="text-align:center;">${employee.name}</td>
                  <td style="text-align:center;">${employee.phone}</td>
                  <td style="text-align:center;">${employee.email}</td>
                  <td><button onclick="showEditForm('${employee.eid}')">Edit</button><button data-eid="${employee.eid}">Delete</button></td>
                `;
                employeeList.appendChild(tr);
              });
            })
            .catch(error => console.error(error));
        } else {
          // pull the data from the API for the specific eid
          fetch(`http://127.0.0.1:5000/employee?eid=${search}`)
            .then(response => response.json())
            .then(data => {
              const employee = data;
              const employeeList = document.getElementById('employee-list');
              employeeList.innerHTML = ''; // Clear all data table before adding new data
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="text-align:center;">${employee.eid}</td>
                <td style="text-align:center;">${employee.name}</td>
                <td style="text-align:center;">${employee.phone}</td>
                <td style="text-align:center;">${employee.email}</td>
                <td><button onclick="showEditForm('${employee.eid}')">Edit</button><button data-eid="${employee.eid}">Delete</button></td>
              `;
              employeeList.appendChild(tr);
            })
            .catch(error => console.error(error));
        }
      }
          // ADD Data

        const showFormButton = document.getElementById('show-form-to-add-employee');
        const form = document.getElementById('from-to-add');
        const successMessage = document.getElementById('success-message');
        const apiEndpoint = 'http://127.0.0.1:5000/employee?eid=*';

        const isFormVisible = localStorage.getItem('isFormVisible') === 'true';
        form.style.display = isFormVisible ? 'block' : 'none';

        showFormButton.addEventListener('click', event => {
          form.style.display = form.style.display === 'none' ? 'block' : 'none';
          localStorage.setItem('isFormVisible', form.style.display === 'block');
        });

        form.addEventListener('submit', event => {
          event.preventDefault();

          const postData = {
            eid: form.elements.eid.value,
            name: form.elements.name.value,
            phone: form.elements.phone.value,
            email: form.elements.email.value
          };

          const options = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
          };

          fetch(apiEndpoint, options)
            .then(response => {
              if (response.ok) {
                successMessage.style.display = 'block';
                form.reset();
                setTimeout(() => {
                  successMessage.style.display = 'none';
                  form.style.display ='none';
                }, 2500);
                return response.json();
              } else {
                throw new Error('Failed to post data to API.');
              }
            })
            .then(data => {
              console.log('Data posted to API:', data);
              // Do something with the response data, if needed
            })
            .catch(error => {
              console.error(error);
              // Handle errors that occurred during the request
            });
        });

            // DELETE data

        function deleteEmployee(eid) {
        // Send a DELETE request to the API with the eid value
        fetch(`http://127.0.0.1:5000/employee`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({eid: eid})
        })
        .then(response => {
          // If the request is successful, remove the corresponding table row
          const row = document.querySelector(`#employee-list tr[data-eid="${eid}"]`);
          row.parentNode.removeChild(row);
          const successMessage = document.getElementById('delete-success-message');
          successMessage.style.display = 'block';
        })
        .catch(error => console.error(error));
      }

      // Add an event listener to the employee list table
      const employeeList = document.getElementById('employee-list');
      employeeList.addEventListener('click', (event) => {
        const target = event.target;
        // Check if the clicked element is a delete button
        if (target.tagName === 'BUTTON' && target.textContent === 'Delete') {
          const eid = target.getAttribute('data-eid');
          deleteEmployee(eid);
          const successMessage = document.getElementById('delete-success-message');
          successMessage.style.display = 'block';
          setTimeout(() => {
            successMessage.style.display = 'none';
          }, 2500);
        }
      });

        // PUT Data
        function showEditForm(employeeId) {
        const formContainer = document.getElementById('edit-form-container');
        if (formContainer.style.display === "none" || formContainer.style.display === ''){
          formContainer.style.display = 'block'; // Show the form container
          // Populate the form with the employee data
          const nameInput = document.getElementById('nameput');
          const phoneInput = document.getElementById('phoneput');
          const emailInput = document.getElementById('emailput');

          // Fetch the employee data from the API
          fetch(`http://127.0.0.1:5000/employee?eid=${employeeId}`)
            .then(response => response.json())
            .then(data => {
              nameInput.value = data.name;
              phoneInput.value = data.phone;
              emailInput.value = data.email;
            })
            .catch(error => console.error(error));
        } else{
          formContainer.style.display = 'none';
        }
        
        const form = document.getElementById('form_to_put');
        const successMessage = document.getElementById('put-success-message');
        
        form.addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent the form from submitting normally

        // Get the employee ID
        // const employeeId = document.getElementById('searchid').value;

        // Get the form data
        const name = document.getElementById('nameput').value;
        const phone = document.getElementById('phoneput').value;
        const email = document.getElementById('emailput').value;
        
        const data = {
          eid: employeeId,
          name: name,
          phone: phone,
          email: email
        };

        // Send the PUT request to update the employee data
        fetch(`http://127.0.0.1:5000/employee`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
          .then(response => response.json())
          .then(data => {
            console.log('Updated data:', data);
            successMessage.style.display = 'block'; // Show the success message
            form.reset(); // Reset the form
            setTimeout(() => {
              formContainer.style.display ='none';
              successMessage.style.display = 'none';
          }, 2500);
            
          })
          .catch(error => console.error(error));
      });
      }

    </script>
</body>
</html>